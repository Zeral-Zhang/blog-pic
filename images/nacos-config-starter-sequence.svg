<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="555px" preserveAspectRatio="none" style="width:2117px;height:555px;background:#FFFFFF;" version="1.1" viewBox="0 0 2117 555" width="2117px" zoomAndPan="magnify"><defs><filter height="300%" id="f12jzzlderqnhl" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="122" x2="122" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="331" x2="331" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="500.5" x2="500.5" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="709.5" x2="709.5" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="862.5" x2="862.5" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1142.5" x2="1142.5" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1284" x2="1284" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1416" x2="1416" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1565" x2="1565" y1="40.4883" y2="511.8359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1811" x2="1811" y1="40.4883" y2="511.8359"/><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="230" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="216" x="12" y="25.5352">NacosConfigAutoConfiguration</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="230" x="5" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="216" x="12" y="531.3711">NacosConfigAutoConfiguration</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="161" x="249" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="256" y="25.5352">NacosConfigManager</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="161" x="249" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="256" y="531.3711">NacosConfigManager</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="108" x="444.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="94" x="451.5" y="25.5352">ConfigService</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="108" x="444.5" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="94" x="451.5" y="531.3711">ConfigService</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="176" x="619.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="162" x="626.5" y="25.5352">NacosContextRefresher</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="176" x="619.5" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="162" x="626.5" y="531.3711">NacosContextRefresher</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="103" x="809.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="816.5" y="25.5352">ClientWorker</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="103" x="809.5" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="816.5" y="531.3711">ClientWorker</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="87" x="1097.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="1104.5" y="25.5352">CacheData</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="87" x="1097.5" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="1104.5" y="531.3711">CacheData</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="68" x="1248" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="1255" y="25.5352">Listener</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="68" x="1248" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="1255" y="531.3711">Listener</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="168" x="1330" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="154" x="1337" y="25.5352">ConfigTransportClient</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="168" x="1330" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="154" x="1337" y="531.3711">ConfigTransportClient</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="103" x="1512" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1519" y="25.5352">RefreshEvent</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="103" x="1512" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1519" y="531.3711">RefreshEvent</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="135" x="1742" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="121" x="1749" y="25.5352">ContextRefresher</text><rect fill="#FEFECE" filter="url(#f12jzzlderqnhl)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="135" x="1742" y="510.8359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="121" x="1749" y="531.3711">ContextRefresher</text><rect fill="#EEEEEE" filter="url(#f12jzzlderqnhl)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2110.5" x="0" y="71.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2110.5" y1="71.1436" y2="71.1436"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2110.5" y1="74.1436" y2="74.1436"/><rect fill="#EEEEEE" filter="url(#f12jzzlderqnhl)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="57" x="1026.75" y="60.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="1032.75" y="77.0566">初始化</text><polygon fill="#A80036" points="319.5,111.1094,329.5,115.1094,319.5,119.1094,323.5,115.1094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="122" x2="325.5" y1="115.1094" y2="115.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="129" y="110.3672">自动配置 Bean</text><polygon fill="#A80036" points="488.5,140.4199,498.5,144.4199,488.5,148.4199,492.5,144.4199" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="331.5" x2="494.5" y1="144.4199" y2="144.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="338.5" y="139.6777">使用 NacosFactory 创建</text><polygon fill="#A80036" points="511.5,169.7305,501.5,173.7305,511.5,177.7305,507.5,173.7305" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="505.5" x2="708.5" y1="173.7305" y2="173.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="517.5" y="168.9883">使用 ConfigService 注册监听器</text><polygon fill="#A80036" points="851,199.041,861,203.041,851,207.041,855,203.041" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="500.5" x2="857" y1="203.041" y2="203.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="241" x="507.5" y="198.2988">ClientWorker 负责实际的注册、轮询作业</text><polygon fill="#A80036" points="1131,228.3516,1141,232.3516,1131,236.3516,1135,232.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="863" x2="1137" y1="232.3516" y2="232.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="870" y="227.6094">根据 DataId 和 group 找到相应 CacheData</text><polygon fill="#A80036" points="1272,257.6621,1282,261.6621,1272,265.6621,1276,261.6621" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1143" x2="1278" y1="261.6621" y2="261.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="1150" y="256.9199">添加自身数据监听器</text><rect fill="#EEEEEE" filter="url(#f12jzzlderqnhl)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="2110.5" x="0" y="290.3174"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2110.5" y1="290.3174" y2="290.3174"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="2110.5" y1="293.3174" y2="293.3174"/><rect fill="#EEEEEE" filter="url(#f12jzzlderqnhl)" height="23.3105" style="stroke:#000000;stroke-width:2.0;" width="70" x="1020.25" y="279.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="1026.25" y="296.2305">配置变更</text><polygon fill="#A80036" points="1404,330.2832,1414,334.2832,1404,338.2832,1408,334.2832" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="863" x2="1410" y1="334.2832" y2="334.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="870" y="329.541">使用传输层代理轮询变更</text><polygon fill="#A80036" points="1154,359.5938,1144,363.5938,1154,367.5938,1150,363.5938" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1148" x2="1415" y1="363.5938" y2="363.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="211" x="1160" y="358.8516">根据 DataId 和 group 找到实际变更</text><polygon fill="#A80036" points="1272,388.9043,1282,392.9043,1272,396.9043,1276,392.9043" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1143" x2="1278" y1="392.9043" y2="392.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="1150" y="388.1621">触发自身的监听器</text><polygon fill="#A80036" points="1553.5,418.2148,1563.5,422.2148,1553.5,426.2148,1557.5,422.2148" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1284" x2="1559.5" y1="422.2148" y2="422.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="1291" y="417.4727">监听器发送 Spring RefreshEvent</text><polygon fill="#A80036" points="1799.5,447.5254,1809.5,451.5254,1799.5,455.5254,1803.5,451.5254" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1565.5" x2="1805.5" y1="451.5254" y2="451.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="222" x="1572.5" y="446.7832">Spring ContextRefresher 监听该事件</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1811.5" x2="1853.5" y1="480.8359" y2="480.8359"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1853.5" x2="1853.5" y1="480.8359" y2="493.8359"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1812.5" x2="1853.5" y1="493.8359" y2="493.8359"/><polygon fill="#A80036" points="1822.5,489.8359,1812.5,493.8359,1822.5,497.8359,1818.5,493.8359" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="1818.5" y="476.0938">refreshEnvironment、RefreshScope.refreshAll</text><!--MD5=[09361d8e48699c3e4d01f79a7f10cbfa]
@startuml
'https://plantuml.com/sequence-diagram

== 初始化 ==

NacosConfigAutoConfiguration -> NacosConfigManager: 自动配置 Bean
NacosConfigManager -> ConfigService: 使用 NacosFactory 创建
NacosContextRefresher -> ConfigService: 使用 ConfigService 注册监听器
ConfigService -> ClientWorker: ClientWorker 负责实际的注册、轮询作业
ClientWorker -> CacheData: 根据 DataId 和 group 找到相应 CacheData
CacheData -> Listener: 添加自身数据监听器

== 配置变更 ==

ClientWorker -> ConfigTransportClient: 使用传输层代理轮询变更
ConfigTransportClient -> CacheData: 根据 DataId 和 group 找到实际变更
CacheData -> Listener: 触发自身的监听器
Listener -> RefreshEvent: 监听器发送 Spring RefreshEvent
RefreshEvent -> ContextRefresher: Spring ContextRefresher 监听该事件
ContextRefresher -> ContextRefresher: refreshEnvironment、RefreshScope.refreshAll
@enduml

@startuml

== 初始化 ==

NacosConfigAutoConfiguration -> NacosConfigManager: 自动配置 Bean
NacosConfigManager -> ConfigService: 使用 NacosFactory 创建
NacosContextRefresher -> ConfigService: 使用 ConfigService 注册监听器
ConfigService -> ClientWorker: ClientWorker 负责实际的注册、轮询作业
ClientWorker -> CacheData: 根据 DataId 和 group 找到相应 CacheData
CacheData -> Listener: 添加自身数据监听器

== 配置变更 ==

ClientWorker -> ConfigTransportClient: 使用传输层代理轮询变更
ConfigTransportClient -> CacheData: 根据 DataId 和 group 找到实际变更
CacheData -> Listener: 触发自身的监听器
Listener -> RefreshEvent: 监听器发送 Spring RefreshEvent
RefreshEvent -> ContextRefresher: Spring ContextRefresher 监听该事件
ContextRefresher -> ContextRefresher: refreshEnvironment、RefreshScope.refreshAll
@enduml

PlantUML version 1.2022.0(Wed Jan 12 00:16:42 CST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>